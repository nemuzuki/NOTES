实验用工具

- Cisco Packet Tracer：建立网络拓扑，模拟发包
- Cain：ARP欺骗和DNS欺骗

## 第一章 网络协议安全基础

### 1.网络协议结构

手机移动网络LTE 4G 5G只有数据链路层和物理层

工作在某一层即可识别该层报头

TCP/IP协议族的缺陷：

- ip地址暴露；分组交换使得共享资源的用户收到其他用户影响，攻击数据包被判定为恶意之前都会转发到目标，容易被DDoS攻击
- 因特网没有**认证**，源ip欺骗，路由器不具备溯源功能
- 因特网尽力而为转发，不提供QoS保障，不同应用级别分配网络资源不应相同
- ip不匿名，会绑定位置
- 全球网络基础设施不提供可靠性、安全性保证

### 2.网络协议安全威胁分类

网络漏洞分类

- 基于头部的漏洞：故意让标识字段异常，导致协议栈错乱。如TCP的FLAG误用攻击，让SYN和FIN同时为1
- 基于协议：不按顺序发数据包
- 基于验证：ip欺骗
- 基于流量：雪崩，广播要求有回应，ping反射放大攻击

按网络层次分类

- 应用层：web攻击，病毒木马
- 传输层：TCP欺骗，DDos
- 网络层：IP欺骗
- 链路层：MAC欺骗，ARP欺骗
- 物理层：物理设备破坏，线路侦听

### 4.网络攻击过程

#### 4.1 网络扫描技术

对目标试探性通信以获取目标信息。分为主机扫描、端口扫描、操作系统识别、漏洞扫描

1.主机扫描：项目表主机发送探测包，看是否收到响应。包括

- ICMP扫描：直接发送ICMP请求，等响应（如ping）；
- 故意发送错误首部的ip数据报，看是否返回“参数问题”ICMP/错误分片的ip数据报，返回“分片重组超时”ICMP。例如发送长度超过MTU的数据报，并且设置禁止分段

2.端口扫描

TCP扫描：

- TCP全连接扫描：与目标端口建立连接。不隐蔽
- SYN扫描：只发送SYN包，不建立连接，如果收到ACK/SYN则端口开放；RST则端口关闭
- FIN扫描：只发送FIN包，如果没收到则端口开放；收到RST则端口关闭
- Xmas扫描和Null扫描

FTP代理扫描：客户端通过FTP服务器向目标主机建立数据连接，可以穿越防火墙

UDP扫描：发送UDP数据包，若开放则不响应，关闭则返回ICMP端口不可达

3.扫描隐匿性策略：避免扫描被发现

- 随机端口扫描
- 慢扫描
- 分片扫描：将TCP连接控制报文分成多个短IP报文段传送
- 伪造源地址

4.nmap工具

在Nmap中，使用nmap –sP xx指令实现主机扫描，用wireshark抓取扫描过程中的ARP请求和响应报文；

```sh
$ nmap -sP 192.168.10.0/24	# 主机扫描
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-02 19:23 CST
Nmap scan report for localhost (192.168.10.2)
Host is up (0.00043s latency).
Nmap scan report for localhost (192.168.10.131)
Host is up (0.00022s latency).
Nmap done: 256 IP addresses (2 hosts up) scanned in 3.06 seconds
```

通过ping指令发起ICMP扫描，用wireshark抓取扫描过程中的ICMP报文。

```sh
$ ping 192.168.10.2
```

在Nmap中，使用nmap –sS xx（S代表SYN）指令实现端口扫描，用wireshark抓取扫描过程中的TCP报文。向每个端口发送第一次握手的SYN报文，来判断端口是否开启

```sh
$ nmap -sS 192.168.10.2 # 端口扫描
```

5.扫描的防御

反扫描技术，端口扫描监测工具，防火墙技术，审计技术



#### 4.2 网络监听技术

监听：截获计算机之间通信数据

共享式网络监听：总线型以太网采用广播，所有主机都能收到数据帧，但只有目的MAC地址匹配才会处理。如果网卡开启混杂模式，主机就能够处理所有收到的数据帧，不管MAC地址

交换网络监听

- 端口镜像：交换机把端口A的数据镜像到其他端口
- MAC洪泛：MAC表中没有目的地址时，向所有端口广播数据
- 端口盗用：改变MAC地址与端口的对应关系
- ARP欺骗：B向A冒充C的mac地址，向C冒充A的mac地址

wifi流量劫持

DHCP欺骗：黑客给用户配置IP、网关、dns地址，将数据报劫持到黑客主机

DNS欺骗：将错误的域名记录存入缓存



#### 4.3 DoS攻击

Denial of service：拒绝服务；DDoS：分布式拒绝服务攻击

1.剧毒包型DoS：利用协议漏洞，发送畸形数据包

- 泪滴攻击：向受害者发送偏移地址重叠的UDP数据包分片，使得目标机器在将分片重组时崩溃
- 循环攻击：使得两个端口之间不断互相发数据包，通过冒充端口实现

2.风暴型DoS：通过大量无用数据包占用资源

- TCP洪流：发送大量建立连接的包，占内存
- ICMP echo
- UDP洪流

3.重定向型：修改DNS缓存

4.DoS攻击防御

检测：流量超出正常极限，不正常的数据包等

防范：限制带宽，入口过滤

流量清洗

密码学课程：[05 加解密基本操作 替换 移位 编码_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1vq4y1R7Yt?p=5&vd_source=2793d10b8cf08aabb7e1bd2c2f146694)5-12

思科Cisco Packet Tracer教程：https://www.bilibili.com/video/BV1At411f7hJ?p=6&vd_source=8f548ea160f252d8ecc356a3171c8ce5

## 第二章 链路层协议安全

三张表

- 路由器：路由表
- 交换机上：MAC转发表
- 主机：ARP表

![](pic/net/计网三张表.png)

### 1.有线以太网802.3

局域网中没有路由器，广播，是共享网络（不是点对点）。适配器检查MAC帧的地址，如果是本站则收下，否则丢弃

早期为总线型结构，使用CSMA/CD来**检测冲突**，先听后发，使用退避算法避免都等待后又出现冲突

扩展局域网：用集线器连接各局域网，形成了一个更大的冲突域，平分了吞吐量；交换机隔离了冲突域，每个端口有专用的容量，总容量随端口数量增加而增加

交换机转发原理：交换机的CAM（内容可寻址存储器）中有MAC转发表（MAC地址，端口号）自学习源MAC地址，如果目的MAC地址在表中也没有就广播；MAC地址表的老化时间是300秒

安全威胁：攻击者伪造大量源MAC地址来填满CAM表，网络中一旦出现目的地址不属于表的帧，交换机就会广播，攻击者得以监听到

#### MAC欺骗（端口盗用）

C修改自己的MAC地址为A的MAC，向B发一个帧，这样交换机MAC转发表中A的MAC对应的端口被替换为C对应的端口，于是B->A时会发给C

#### ARP欺骗

一台主机只有一个MAC地址，可以有多个IP地址，在数据链路层交换机需要直到mac地址才能转发，所以需要ARP协议来获取ip对应的mac。ARP缓存表（IP地址，MAC地址）位于主机中

ARP请求：广播【谁的IP是xx，请返回MAC地址】

ARP欺骗：攻击者C向B主动发送ARP响应【A的ip对应的MAC地址是C的MAC】

检测：出现大量ARP reply

防御：MAC地址绑定；静态ARP缓存

### 2.无线网络802.11

多个无线终端设备连接一个访问接入点AP（AP的名字也就是WiFi名，称为SSID服务集识别码），形成BSS基本服务集

安全威胁：

- 恶意AP假冒成合法AP：高仿AP的SSID，放大无线信号
- 内部人员搭建AP，使远处人员进入内网

使用CSMA/CA**避免冲突**：无线信号碰撞，一定球体范围外的节点不会知道。假设A和D都想给B发，A先发给B探测帧RTS，B应答空闲CTS，D听到CTS后等待一段时间再发

802.11加密方法：

- WEP有限对等私有协议
- WPA加密：无线保护接入

### 3.VLAN

传统局域网内设备过多，会产生广播风暴，因此使用路由器分割广播域，但路由器根据**软件**查路由表找下一跳，转发效率低

虚拟局域网VLAN可以隔离广播域，也可以将不在一个交换机下的两个主机放在一个广播域

- 基于端口的VLAN（静态）：交换机VLAN表（端口，VLAN号），绑定了端口
- 基于MAC地址的VLAN（动态）：（mac地址，VLAN号），主机位置变化VLAN不变

| VLAN  | 端口 |
| ----- | ---- |
| VLAN1 | 3    |
| VLAN2 | 2    |
| VLAN1 | 1    |

三层交换机

- 跨VLAN通信需要三层交换机，因为跨越了广播域，ip子网不同

- 一次路由，多次转发：只有当A给B第一次发数据时，不知道mac地址，用软件转发表（目的IP，下一跳IP），并使用arp协议获得下一跳mac，以后用硬件转发表（目的IP，下一跳mac，VLAN，端口）来转发。加快了数据交换

VLAN二层交换机端口

- access端口：连接主机，只能属于一个VLAN
- trunk端口：交换机之间连接，可以属于多个vlan

帧中会带上VLAN标记，交换机删除标记后发给主机。如果没有标签，就发给默认的VLAN1（本征VLAN，native VLAN）。如果一个帧来自trunk端口，并且标签为VLAN1，则标签会被去掉，自动转发到本征VLAN；一个帧来自VLAN1端口但有VLAN2标签，该帧会被丢弃

<img src="pic/net/VLAN链路.png" style="zoom:67%;" />

#### VLAN安全威胁

双标签跳跃攻击：攻击者在VLAN1想访问VLAN2，发一个帧带两个标签VLAN1和VLAN2，经过trunk链路后，交换机会去掉VLAN1标签，剩下2标签

#### 作业2 VLAN防MAC地址欺骗攻击

为了防止C冒充A的mac欺骗，将A和B划分到VLAN2，将C划分到VLAN1，这样C的报文就无法发给B。同时，交换机中每个VLAN有独立的转发表（VLAN号，mac，端口），所以相同MAC但VLAN号不同也不会被覆盖

## 第三章 网络层协议安全

### 1.IP安全

#### 1.1 IPv4

IP层不对数据部分校验

IP数据报以信源网络的MTU进行封装，在传输过程中再进行动态分片

IP选项：IP数据报首部的变长部分。
源路由选项：控制IP数据报发送时的传输路径

- 严格源路由：选项中的ip地址表列出了每个路由器的ip，必须严格按照发送方规定的路径穿过每一个路由器
- 宽松源路由：只给出关键点，通过路由器的自动路由选择功能进行补充

IPv4受限广播地址：255.255.255.255，只有DHCP时不知道网关ip时探测用。路由器不会转发目的为受限广播地址的数据报，只能在本网段                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

直接广播地址：只有主机位全1，可以跨网段广播



IP欺骗：源IP换成内网的IP发送数据包给内网主机，但是收不到回复。防范：入口过滤，出口过滤

源路由欺骗：利用源路由选项加入原本的IP来获取应答（有的路由器支持发包和回包都用源路由）

#### 1.2 ICMP

ICMP在IP数据报的数据部分，有类型字段

死亡之ping攻击：缓冲区溢出攻击。IP包最大65535字节，构造一个超大的包超出目的主机上的IP重组缓冲区，数据溢出到其他区域，主机受到后可能会蓝屏。`ping -l 65500 192.168.1.1 -t`：发一个ICMP长度为65500包，则IP长度超过了65535。防范：os发现超大包就丢弃

ICMP Smurf攻击：冒充被攻击主机A的IP在内网广播，内网所有主机都会回应A ICMP echo，造成DoS

ICMP重定向：路由器R2检测到IP数据报经非优路由传输，就通过ICMP重定向报文通知主机去往该目的地的最优路径，通过R1。重定向攻击：R1和R2是同伙，让主机都发给R1

#### 1.3 IPv4安全机制

##### 访问控制列表ACL

应用在路由器接口上的指令列表，这些指令告诉路由器哪些数据包分组可以接收，哪些数据包分组需要拒绝

标准ACL只看源IP。新来数据报时，从上到下匹配配置语句，一旦判断出来能否通过就不再向后检查

扩展ACL：根据数据包的源IP地址、源端口号、目标IP地址、目标端口号等特征判断允许或拒绝通过

##### NAT网络地址转换

私网IP地址映射到公网IP地址

静态NAT配置：私有ip一一映射到公用ip；动态NAT：私网ip多，需要争用有限的公网ip

端口地址转换PAT：内网socket映射到公网socket，端口随机



##### VPN虚拟专用网络

跨越因特网，将两个网络相连成一个网络

VPN的功能

- 保护数据的机密性
- 完整性
- 身份认证
- 重放攻击

传数据都使用对称加密，因为效率高；交换密钥再使用非对称加密



防中间人攻击：预共享密钥；数字证书

数字证书：**用CA的私钥加密的Bob的公钥得到的结果**。Alice有CA的公钥（浏览器自带），来解密出来Bob的公钥，保证了这个公钥确实是Bob的，而不是中间人的



##### IPSec协议

传统IP协议缺乏双方身份鉴别，数据完整性和机密性保护，监听、重放攻击。IPSec不基于证书，采用预共享密钥来认证

IPSec提供的安全服务（位于网络层）

- 机密性：数据先加密再传输
- 完整性：在目的地hash验证
- 身份验证：数字签名保证数据来自正确的创建者
- 防重放：报文有序列号

IPSec不是一个单独的协议

- AH（认证头）提供完整性验证、数据源身份验证、防重放攻击
- ESP（封装安全载荷）提供上述三种服务，以及数据包加密、数据流加密。ESP有ESP尾
- IKE（因特网密钥交换）实现密钥交换

<img src="pic/net/IPSec体系.png" style="zoom:60%;" />

VPN有两种运行模式，都是在要加密的部分两边加上VPN头和VPN尾

- 传输模式：不加密头部。用于主机之间
- 隧道模式：加密整个包，然后加上新的IP头。用于网关之间

<img src="pic/net/IPSec格式.png" style="zoom:60%;" />

（1）AH和ESP协议

- AH用来做完整性校验，用哈希密钥来对报文（包括原始IP头）哈希，放到AH头的认证数据字段
- ESP用来完整性和加密，ESP头是安全参数索引SPI和序列号，ESP尾里面有对报文（不包括原始IP头）先加密再哈希的认证数据
- 因为哈希的部分不同，所以ESP不能完全替代AH-ESP，此外没必要加密时使用AH
- 当IPSec VPN穿越NAT时，不能使用AH，因为IP头变化了

哈希密钥和加密密钥需要双方使用IKE自动协商，IKE的主要功能就是在通信双方协商SA

（2）SA安全关联

SA（安全关联）：协商了两个IPSec实体之间使用什么协议、运行模式、加密算法等，格式为三元组（SPI索引号，IP目的地址，IP安全协议）。
SA是单向的，每个通信方有两种SA，进入SA和外出SA来处理要接收和发送的数据包。SPI用于标识具有相同IP地址和相同安全协议的不同的SA，位于AH或ESP头中。SA由SPD和SAD组成
SAD（安全关联数据库）：一个将所有的SA以某种数据结构集中存储的列表

SP（安全策略）：决定对IP数据包提供何种保护，并以何种方式实施保护。格式为（源IP，目的IP，处理方式），处理方式有三种：丢弃、不用IPsec、使用IPsec
SPD（安全策略数据库）：一个将所有的SP以某种数据结构集中存储的列表，当接收或发送IP包时，首先查询SPD来决定如何处理

一个完整的IPSecVPN工作原理

对于发出的流量

- 首先查找SPD看（源IP，目的IP）对应的安全策略
- 然后需要建立相应的安全关联SA（包含一个SPI索引），并存储到SAD中
- 以后再发送时，直接根据SA在SAD中查到相应的行，就不用再重新写入SAD了

对于进入的流量：从包中获得SA三元组，根据索引在SAD中查找相应的SA

（3）IKE因特网密钥交换

ISAKMP：是IKE的一个框架。

IKE有两个阶段：

- 阶段1主模式（main mode）6个报文。1-2协商参数，3-4交换对称会话密钥，5-6双方用会话密钥进行身份认证。建立控制连接的密钥交换
- IKE阶段2快速模式（quick mode）3个报文。建立数据连接的密钥交换      

认证方法有两种：基于与共享字符串、基于数字证书                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

#### 1.4 IPv6

共16*8=128bit

IPv6的payload包括扩展首部和数据部分。扩展首部可以加入特定协议的报头，如路由报头、AH报头

ipv6地址=全球路由前缀GRP||子网ID||主机接口ID。接口ID：将48比特的MAC地址转化为64比特的接口ID。ipv6没有子网掩码，固定好了子网位数

ipv6只有没有单播、多播和任播地址，没有广播地址，使用更有限的多播替代广播。

多播地址：前面8bit都是FF，后面80bit全0，最后32bit是多播组id

- 所有节点的多播地址：FF02:0:0:0:0:0:0:1
- 所有路由器的多播地址：FF02:0:0:0:0:0:0:2

任播地址：适用于一个主机对一个组中的一个主机（one to one of many）的通信需求

本地链路地址FE80::/64：用于在局域网中（连接到同一本地链路的节点之间）邻居发现，后64位是接口ID

本地站点地址FEC0::/64：类似于IPV4的私有地址

ipv6地址配置技术

- 无状态自动配置地址：主机先多播路由器请求RS（Router Solicitation）报文（src=本地链路地址，dst=所有路由器的多播地址），路由器回复路由器通告RA（Router Advertisement）报文（src=本地链路地址，dst=所有节点的多播地址）
- 有状态自动配置：需要配备专门的DHCP服务器

ICMPv6：实现IPv4中ICMP、ARP和IGMP的功能。封装在IPv6中

邻居发现协议NDP（Neighbor Discovery Protocol）：不是一个全新的协议，由IPv4中的地址解析协议ARP、ICMP路由探测协议RDISC、ICMP报文重定向等协议综合而成。

IPv6的安全改进

- 使用端到端IPSec
- 真实源地址检查体系
- 防扫描：子网内地址过多（2^64），难以遍历
- 可溯源：不使用NAT，每个中断都有和身份绑定的IP地址
- 防止网络放大攻击：没有广播
- 防止碎片攻击：IPv6认为MTU小于1280字节的数据包是非法的，除非最后一个包都会被丢弃

IPv6的缺陷

- IPv6扩展报头的安全问题
- ICMPv6协议安全威胁
- NDP协议攻击
- 对安全硬件的影响

### 2.BOOTP和DHCP安全

BOOTP：引导程序协议，BOOTP服务器接收客户的硬件地址并分配IP

DHCP是BOOTP的扩充，可以用来使主机动态获取IP、DNS服务器地址、网关地址

DHCP欺骗：

- 攻击者发送大量DHCP请求，消耗完全部ip地址池，使得dhcp服务器无法为其他客户端分配ip；
- 之后攻击者自己架设DHCP服务器做后续的响应，对于IP、DNS、网关地址给出错误的值，分别可以导致客户端无法访问远程网络、DNS欺骗（钓鱼网站）、中间人攻击

防御：当交换机从一个不可信任端口收到DHCP服务器的报文时，直接丢弃

### 3.路由协议安全

IGP：内部网关协议；BGP：外部网关协议

距离向量协议：

- 仅和相邻节点交换自己的路由表。只知道和目的网络的距离（中间隔了几个路由器）和下一跳接口，不知道整条路径
- 缺点是慢收敛，路由环路
- RIP、BGP

链路状态协议：

- 链路状态发生变化时，通过泛洪向所有节点发送与本路由器相邻的所有路由器的链路状态，每个节点维护全局拓扑
- 缺点：耗费资源
- OSPF

![](pic/net/路由协议位置.png)

#### RIP

RIP：在UDP之上，每30s向多播地址（邻居）发送自己的路由表，路由信息生命期为180s

路由环路：r2-r3-r4，如果r4被删除，r2表中r4距离仍为1，那么r3表中r4距离更新为1+1=2。

如何避免环路：

- 路由毒化：告知已经失效的路由不可达；
- 水平分割：禁止路由器将从一个接口学习到的路由再从同一个接口通告出去；
- 毒性逆转：指当路由器r从一个接口学习到去往某个网络的路由时，它就向该接口发送该路由从r不可达

RIP路由欺骗：由于RIP没有认证，所以攻击者可以发送错误的RIP包修改路由器的路由信息（下一跳）。具体方法：攻击者先伪装成r1来将度量值改大发送RIP，再换成度量值更小的真实ip发送RIP，这样r2的路由表的路径就经过了攻击者

RIPv2报文验证机制：路由信息通过哈希密钥进行哈希，接收方比对

#### OSPF

RIP的缺陷：慢收敛，跳数短并非最佳路径（还要考虑带宽），最大16跳导致网络尺度小

OSPF：只有30mim/当链路状态发生变化时，采用泛洪发送与本路由器相连的所有路由器的链路状态。

工作过程：

- 寻找邻居
- 建立邻接关系
- 传递链路状态信息（LSDB），LSDB是LSA（链路状态通告）的集合
- Dijkstra计算路由（代价不只是距离）

安全机制

- 报文认证机制：采用md5认证，由共享密钥和路由消息共同生成消息鉴别码MAC，保证完整性防篡改
- 层次化路由：自治系统AS内部划分，使得区域间屏蔽不互相影响
- 可靠泛洪：使用类似TCP的确认重传机制保证可靠性

#### BGP

BGP用于在AS之间传递路由信息，部署在AS边界的路由器上。基于TCP

BGP有三张表

- 邻接表
- BGP表：保存从每一个邻居学到的路由信息
- 路由表

外部BGP（EBGP）：指的是属于不同AS的两个BGP路由器

内部BGP（IBGP）：指的是属于同一个AS的两个BGP路由器

BGP通告：从外部来的路由会向所有BGP邻居通告，从内部来的不向内部邻居通告

为了避免出现环路，采用IBGP全连接

BGP同步：AS内部路由器也要有到外部路由器的路由信息，（AS100-AS200-AS300，BGP同步使得AS200内部的路由器也要有到AS100的路由，否则AS300没法访问AS100）。默认不同步，路由表小，可能可以采用隧道技术在跨AS的数据包外面嵌套内部路由的信息，到达边缘BGP再拆开

AS商业关系

- 从peer和provider来的只发给customer

BGP安全特性：GTSM检查IP报文头中的TTL值是否在一个预先定义好的范围内

##### BGP安全威胁

- 前缀劫持：一个攻击者的BGP路由器向外宣告它实际上不控制的IP前缀（子网A）的路由，使得所有要去A的流量发到攻击者这里

- 路径伪造：攻击者向AS发送路由通告，声称自己到一个AS的路径更短

- 路由泄露：BGP路由通告传播到其原本预期通告范围之外，导致网络不可达

##### BGP安全技术




## 第四章 传输层协议安全

### UDP安全

UDP因为不用建立连接，所以网络拥塞也不会使源主机发送速率降低

UDP安全威胁

- UDP泛洪攻击：利用大量UDP小包冲击DNS服务器或Radius认证服务器、流媒体视频服务器
- UDP反射放大攻击：伪造成受害者的源地址发送请求给僵尸主机，使得受害者收到大量响应包。由于UDP响应包远大于请求包，造成目标拥塞

### TCP安全

TCP发送窗口=min（接收窗口rwnd，拥塞窗口cwnd）

拥塞控制：慢启动（cwnd指数增长），拥塞避免（线性增长），快速重传（3个冗余ACK立即重传），快速恢复（3个冗余ACK进入拥塞避免）。3个冗余实际上是出现了4个相同的ACK

- SYN泛洪攻击：攻击者伪造大量假地址发送SYN，server一旦收到SYN，就要分配TCB(Transmission Control Block)内存来等待建立连接
- ACK泛洪：server一旦收到ACK，就要在表中检查是否连接过，分别回应ACK/RST，这个过程消耗主机和防火墙的CPU资源
- Connection泛洪：利用真实IP地址在server上建立大量连接，占着连接不用，耗尽资源
- LAND攻击：发送一个源目的IP相同的SYN报文，当操作系统接收到这类数据包时，或者不知道该如何处理，或者循环发送和接收该数据包，消耗系统资源
- FLAG误用攻击：标志位相互矛盾，如ACK&RST，导致网关bug
- RST攻击/复位攻击：发送伪造的RST，断掉其他人的通信，造成拒绝服务
- 会话劫持：攻击者伪装成服务器或客户端参与到正在进行通信的TCP连接，需要获取相关信息进行伪造
- 低速率拒绝服务攻击（LDoS）：利用拥塞控制机制，让拥塞窗口一直无法变大，制造网络拥塞

### SSL/TLS协议

HTTPS = HTTP +SSL/TLS，TLS1.0=SSL3.1，提供的服务有：认证、机密性、完整性、防重放。位于TCP之上。主要包括四种协议：

- 握手协议handshake：c-s之间相互认证；协商加密算法和MAC（身份鉴别码）算法；协商用于加密SSL载荷的共享密钥；协商用于产生MAC的共享密钥；建立会话
- 告警协议alert：向对方指示安全错误
- 变更密码规则协议：改变密码参数
- 记录协议：封装以上三种协议或应用层数据

握手协议

- client hello：client向server发送随机数，多种密码算法套件
- server hello：server选择一种对称算法、一种公钥算法和一种MAC算法
  server certificate：server的证书链，不包含根证书，因为根需要已经被client信任。也就包含了server的公钥
  server hello done
- client key exchange：**client产生预主密钥，并用server公钥加密**，发给sever。此时双方用预主密钥产生各种所需密钥
  client change cipher sec：通知server使用协商好的算法，client切换为写状态，server切换为读状态。（不属于handshake消息）
  client finished：第一条被加密的消息，验证协商的参数是一致的
- server change cipher sec：通知client使用协商好的算法
  server finished

记录协议：封装数据

会话重用：基于session id，服务器和客户端都保存键值对（session id，主密钥）。client将client hello中的session id字段设为响应值；server收到后查找本地是否有该session_id，如果有，判断当前的加密套件和上个会话的加密套件是否一致，一致则允许使用会话复用

安全威胁：

- Strip中间人攻击：如果用户上网时，域名不写https会重定向到https的网站。客户端和中间人之间使用http连接，中间人和服务器之间使用https，使得用户以为自己使用了https连接
- 重协商攻击：重协商指的是client和server在已协商好的连接上重新协商，更换算法、证书、密钥等。
  - 中间人拦截客户端的协商client hello1
  - 中间人构造client hello2发给服务器作为首次协商
  - 中间人发送一些构造好的数据给server
  - 中间人发client hello1给服务器，服务器认为是重协商
  - client再发数据给server，server会将上次中间人发的数据和本次粘合起来。中间人完成数据注入
- 三次握手攻击
- 心脏滴血（Heartbleed）漏洞：客户端向服务器发送心跳请求(Heatbeat_Request)消息，询问服务器是否在线，该消息中包含payload字段及其对应的payload_length字段；服务器向客户端返回心跳响应(Heatbeat_Response)消息，服务器会根据请求消息中的payload_length将payload复制到响应消息中；服务器并不会检查payload的实际长度是否与payload_length一致；如果payload_length与实际长度不一致，服务器仍然会按照payload_length返回数据，由此造成了内存信息的越界访问

------

## 第五章 应用层协议安全

### 1.DNS安全

DNS基于UDP

- 根域名服务器
- 权威域名服务器：负责维护一个域内的资源记录
- 递归域名服务器：即本地DNS服务器

根域名是`.`，即www.baidu.com.最后的点。顶级域名com，二级域名baidu，三级域名www

区zone：一个域名服务器保存的直接管理的信息的范围。区文件里面是RR信息

**资源记录RR**：存储与域名相关的属性信息，是DNS响应的结果。<Domain Name, TTL, Type, Class, Data>。RR分类：

- A记录：Data字段是最终的IP
- NS记录：继续向下查的域名
- SOA记录：主服务器
- CNAME：别名

CDN内容分发网络：查域名IP时，域名服务器获得CNAME记录，用别名替代查找的域名，返回给本地DNS，再查别名的IP

#### DNS安全威胁

##### 拒绝服务攻击

DNS泛洪：由于DNS基于UDP，所以是UDP泛洪的一种

- 随机子域名攻击：查询大量合法域名的随机子域名，耗尽权威服务器的资源
- 非存在域名攻击：查询大量非存在域名，使得本地DNS一直等待解析响应

DNS反射放大攻击：同UDP

##### DNS欺骗

域名系统接收来自未授权主机的非正确信息

- 缓存投毒：伪造来自权威服务器的响应报文，修改IP映射，发给本地DNS
- 域名劫持：直接攻击权威服务器，修改区文件内的资源记录
- DNS重定向（DNS重绑定攻击）：类似缓存投毒，但攻击的是DNS客户端（用户主机）和本地DNS之间的通信

在对靶机ARP欺骗之后，就可以进行DNS欺骗。靶机向某站点A发送的DNS请求包会先经过攻击机，攻击机给出一个错误的DNS解析，将站点A的域名映射到站点B的IP地址，这样靶机就访问了站点B，常用于钓鱼网站攻击。

##### DNS隐蔽通信

又称DNS隧道，将其他数据和协议(如shellcode)编码为DNS查询和响应报文，以此来躲避防火墙，防火墙一般不会拦截DNS报文。

例如查询一个缓存中没有的域名的IP，将通信数据封装在DNS查询报文中发给权威服务器（采用数据编码技术），权威服务器响应中也封装数据。这种方法可以实现免费蹭网（？

##### 异常域名

恶意域名

- 恶意网站域名

- 僵尸网络域名/算法生成域名DGA：僵尸网络中的僵尸主机由攻击者通过C&C服务器进行控制。为了让僵尸主机们和C&C服务器之间建立信道、获取控制命令，需要用DNS来获取C&C服务器IP

  - 攻击者用seed生成大量域名（逃避检测），选择几个注册，并指向C&C服务器

  - 僵尸主机也用同样的seed生成大量域名，逐个访问看是否存在，若存在就认为是C&C服务器
  - seed可以基于时间、银行利率等。由于随机性可以逃避检测

- 钓鱼网站域名

误用域名

- 一次性域名：用于采集信息

DNSSEC：权威服务器对区文件进行签名，保证IP来源可靠

### 2.HTTP安全

HTTPS/SSL：下层只能TCP，单向验证

IPsec：上层可TCP或UDP，双向验证，会受NAT影响

### 3.终端远程访问协议安全

#### SSL VPN

（不要搞混了SSL（https）和SSH！）

终端https访问虚拟网关（内网的防火墙），虚拟网关http访问内网服务器

端口转发：数据包通过SSL连接中的隧道被传送到SSL VPN网关，SSL VPN网关解开封装的数据包，将它们转发给目的应用服务器

网络扩展：在IP头前面再加一层TCP头和IP头，在虚拟网关处拆开

SSL VPN：同HTTPS，需要证书

#### Telnet SSH

Telnet远程登录协议：明文传输

SSH VPN：不需要证书

### 4.文件传输协议安全

FTP：包含控制连接和数据连接

P2P：torrent文件告知谁有电影，向他们发请求

### 5.电子邮件协议安全

SMTP：因为邮件是单向性和非实时性，双方无法协商密钥，所以不支持隧道加密。因此使用安全电子邮件

PGP（高质量保密）：先用私钥对邮件签名，再用对方证书中的公钥加密对称密钥，对称加密邮件。PGP加密全文本，S/MIME还保护附件

------

## 第六章 基于网络流量的安全防护技术

### 1.防火墙技术

防火墙位于不同信任程度的网络之间，防火墙=硬件+软件+控制策略

路由器基于简单的包过滤，防火墙基于状态

区（Zone）：防火墙有多个接口，可以多接口连接一个安全区域，每个zone有一个安全优先级

为什么用户终端和服务器不能在一个zone？防止外网黑客攻陷服务器后作为跳板机再攻击内网终端

代理防火墙

包过滤防火墙：五元组<源IP，源端口，目的IP，目的端口，动作>，容易被伪造地址攻击

状态检测防火墙：考虑前后报文的历史关联性、对于首包匹配策略，后续的包查找会话表

安全策略：域内、ARP、DNS不禁止

### 2.网络入侵检测技术

入侵检测系统IDS是事后分析

和特征库匹配

机器学习：计算熵



大作业

输入pcap，安装snortt
