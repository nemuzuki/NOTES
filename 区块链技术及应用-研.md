### 第一章 区块链概况

区块结构

区块头：【前一区块头的哈希值||随机数nonce||merkle根】，交易信息一旦改变，merkle根就会变；
区块体：根以外的merkle树。hash选用SHA256，非线性

<img src="pic/block/区块结构.png" style="zoom:60%;" />

分布式系统的共识机制

- 工作量证明POW：矿工试出nonce使得hash值<=阈值，证明了自己的工作量，才能将区块上链（记账）。算得快有优势，浪费算力；

- 权益证明POS：钱多的有优势，不公平，而且要保证选择出块节点的随机性，即在一个范围（钱多）内的节点中使用随机函数，否则节点会被DDoS攻击
- 分布式一致性算法：包括实用拜占庭容错算法PBFT，如果已知用户数量n，恶意用户数量<=1/3即可建立共识。一般用于联盟链，不用于公链

#### 区块上链过程

- 输入信息：一笔交易产生时，先被广播到网络中的其他节点
- 验证信息：包括检查区块的结构是否正确，验证区块的上一个区块是否存在并且有效
- 更新本地状态：各节点通过工作量证明来决定谁可以验证交易，并且选取最优链
- 输出新块：取得验证权的节点将区块广播给所有节点，其他节点会确认这个区块所包含的交易是否有效，确认没被重复花费且具有效数字签名后，接受该区块，区块上链

### 第二章 背景知识

哈希函数H(r||x)=y的性质：

- 抗碰撞性：y的长度n足够长以对抗生日攻击
- 隐藏性：输入分布越均匀，极小熵越大。因此希望原相空间服从高熵分布，使得给定y试不出来x
- 谜题友好：设y长度为n比特，r取自高熵分布，找x的复杂度为O(2^n)

隶属证明：验证merkle树的一个交易（叶节点）存在的时间为O(logn)
非成员证明：叶节点hash值进行排序，二分可知不在树中

数字签名：私钥（sk, secret key）加密，公钥(pk, public key)解密

RSA

- 选两个素数p，q，n=pq
- 计算欧拉函数$\phi(n)=(p-1)(q-1)$
- e与phi(n)互素，一般为65537
- 求出唯一正整数d，使得$(de-1)\mod \phi(n)=0$
- e-n为公钥对，d-n为私钥对
- 设明文M，则密文$C=M^e\mod n$
- 明文$M=C^d\mod n$

ECDSA：DSA的ECC版，**优点是密钥长度短**，安全性强

椭圆曲线$E:y^2 = x^3+ax+b$以及无穷远点O。设P,Q是E上任意两点，PQ交E于R'，R'关于x轴的对称点为R，称为P与Q的和P+Q=R。求解nP=Q的n是难题

高飞币：有铸币和交易两种行为

- 高飞负责铸币
- b->c交易包含a->b交易的hash值，即哈希指针指向钱的源头
- 缺点：双重支付，两比交易都能指向上个交易

财奴币：可以在一次交易中创建多组币

### 第三章 比特币协议

比特币去中心化：P2P网络向所有节点公开，挖矿向所有节点开放，只有挖矿才能创造新币

分布式共识
拜占庭将军问题（口头）：将军发出命令，副官接受命令，少数服从多数。叛徒数量<=1/3可以攻下
PBFT：加入了信道延迟
POW：证明了工作量才能记账，叛徒也需要工作量

无身份共识：随机选择节点来广播区块

双花攻击：

- A ->B的交易由A签名，并用哈希指针指向钱的源头交易，把双花的交易放在最长链（只有一条链，但是会分叉）就双花成功了；
- B需要等待A->B的交易6次确认（后面又链上了6块）后再承认收到了钱，这样双花就无法成功，因为攻击者落后6块能追上的概率很小

![](pic/block/双花攻击.png)

### 第四章 比特币交易

一个交易包含

- 元数据：包括交易哈希值
- 输入：一个解锁脚本（输入脚本），用来解锁源交易的钱。【花钱人的签名，公钥】
- 输出：一个上锁脚本（输出脚本），提供解锁脚本（签名和公钥）才能使用里面的钱转给别人

后一交易的输入脚本和前一交易的输出脚本拼接起来，按顺序压栈，全部入栈后弹栈执行

多重签名：多个人签名才能解锁，可以用来避免双花，即双方都签名

### 第五章 比特币的存储和使用

存储比特币就等于存储拥有比特币者的私钥，这样才能签名

比特币地址：**公钥的hash值**，然后再使用base58编码，除去了相似的字符0、i等

比特币钱包分类：热存储：在线；冷存储：不联网

冷热存储之间转账：分层确定性钱包。冷存储将地址生成信息$(k, g^y)$发给热存储，热存储端可以使用不同的常数$i$一次生成许多冷存储的公钥$g^{x_i}=g^{H(k||i)}g^y$和地址$H(g^{x_i})$，冷存储端可以生成私钥$x_i=y+H(k||i)$，这样热存储就可以将比特币转账给这些公钥生成的地址，冷存储端可以消费这些比特币

密钥分享：n+1个人合作才能得到私钥。但是不能直接分割密钥，否则每个人能获得部分信息，可以采用异或或者多项式法

### 第六章 比特币挖矿

merkle根里包含交易的hash，矿工试nonce，填入区块头

难度（一个二进制串）前面有n个0，平均就要试2^n次

### 第七章 替代挖矿方案

好的谜题：收益和计算量对等



数独解的零知识证明

交互式零知识证明：A要向B证明一个数独有解，但不能告知答案。B**随机选取**行、列、九宫格其中一种检查方法，比如选择了行，B不能事先准备。B将9行数放入9个袋子，每个袋子内打乱发给A。

非交互式：设计一个机器，来随机选择行列九宫格



比特币和零知识证明的关系

在比特币网络中，用户需要将交易明文广播给所有矿工，由他们来校验交易的合法性。但是有些情况下，基于隐私的考虑，又不想把交易的具体内容公布出来



ZeroCash特点是隐私交易，基于ZeroCoin协议进行了改进，引入了zk-SNARKs提升效率。发送交易信息到公网后，ZeroCoin只能隐藏输入输出地址，而ZeroCash还可以隐藏交易数额。

zk-SNARKs（简短零知识证明）是一种零知识证明技术，它是Zero-Knowledge Succinct Non-Interactive Argument of Knowledge的缩写。

- Zero-Knowledge
- Succinct 
- Non-Interactive 
- Argument of Knowledge

比特币使用的挖矿算法是SHA256，Zcash使用的是Equihasash挖矿算法。Equihash算法由Alex Biryukov 和 Dmitry Khovratovich联合发明，其理论依据是一个著名的计算法科学及密码学问题——广义生日悖论问题。

[Zcash挖矿算法深度解析-爱码网 (likecs.com)](https://www.likecs.com/show-204728970.html#sc=432.79998779296875)

### 大作业

山寨币



### 智能合约

区块链类似一个计算机，智能合约是上面运行的程序
